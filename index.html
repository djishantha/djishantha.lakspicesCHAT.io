<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>LAKSPICES LLC — Shop</title>

<style>
  :root{
    --card-pad:12px; --cols:3;
    --page-width:1200px;
  }
  body{font-family:Inter, system-ui, Arial, sans-serif; margin:20px; display:flex; justify-content:center;}
  .wrap{max-width:var(--page-width); width:100%;}
  header{text-align:center; margin-bottom:16px;}
  h1{margin:0 0 12px 0; font-size:26px;}
  .controls{display:flex; gap:8px; align-items:center; justify-content:center; margin-bottom:10px;}
  .grid{display:grid; grid-template-columns: repeat(var(--cols), 1fr); gap:16px; margin-top:18px;}
  .card{border:1px solid #e6e6e6;border-radius:8px;padding:var(--card-pad); background:#fff; display:flex;flex-direction:column; height:100%;}
  .card img{width:100%; height:160px; object-fit:cover; border-radius:6px;}
  .meta{margin-top:8px; flex:1;}
  .title{font-weight:700;}
  .desc{font-size:13px; color:#444; margin-top:6px;}
  .price{font-weight:800; margin-top:8px;}
  .stock{margin-top:6px;}
  .notavail{color:#b00000; font-weight:700;}
  .card-footer{display:flex; gap:8px; align-items:center; margin-top:10px;}
  button{cursor:pointer; padding:8px 10px; border-radius:6px; border:1px solid #ccc; background:#f7f7f7;}
  button.primary{background:#1a73e8; color:white; border-color:#1669c1;}
  button:disabled{opacity:0.5; cursor:not-allowed;}
  .cart{position:fixed; right:20px; top:20px; width:320px; border:1px solid #e6e6e6; padding:12px; background:white; border-radius:8px; box-shadow:0 4px 14px rgba(0,0,0,0.06); max-height:90vh; overflow-y:auto;}
  .cart h3{margin:0 0 8px 0;}
  .cart-list{max-height:280px; overflow:auto; margin-bottom:8px;}
  .cart-item{display:flex; justify-content:space-between; gap:8px; align-items:center; padding:6px 0; border-bottom:1px dashed #eee;}
  .small{font-size:13px; color:#555;}
  .pager{margin-top:18px; display:flex; gap:8px; align-items:center; justify-content:center;}
  .page-size{width:70px;}
  @media (max-width:1000px){
    .grid{grid-template-columns: repeat(1,1fr);}
    .cart{position:static; width:auto; margin-top:12px; max-height:none;}
  }
</style>

<!-- PayPal SDK -->
<script src="https://js.stripe.com/v3/"></script>

</head>
<body>
<div class="wrap">
  <header>
    <h1>Welcome to LAKSPICES LLC</h1>
  </header>

  <div class="controls">
    <label class="small">Rows per page:
      <select id="rowsPerPage">
        <option value="5">5</option><option value="10">10</option><option value="20">20</option>
        <option value="25" selected>25</option><option value="50">50</option>
      </select>
    </label>

    <label class="small">Search:
      <input id="search" placeholder="name or desc" />
    </label>
  </div>

  <main>
    <div id="grid" class="grid" aria-live="polite"></div>

    <div class="pager" id="pager">
      <button id="prev">Prev</button>
      <div id="pageInfo" class="small"></div>
      <button id="next">Next</button>
    </div>
  </main>

  <div class="cart" id="cart">
    <h3>Cart (<span id="itemCount">0</span> items)</h3>
    <div class="cart-list" id="cartList"></div>
    <div id="total" class="small" style="font-weight:800;margin-bottom:8px"></div>

    <!-- Checkout button + PayPal -->
    <button id="checkoutBtn" class="primary" style="width:100%; margin-bottom:10px;">Checkout</button>
   

    <div style="margin-top:8px; display:flex; gap:8px;">
      <button id="clearCart">Clear</button>
      <button id="exportCart">Export Order</button>
    </div>
  </div>
</div>

<script>
const PRODUCTS_FILE = './products.json'; 
const COLS = 3;

let products = []; 
let filtered = [];
let page = 1;
let rows = 25; 
let cart = loadCart();

/* ============ Init ============ */
document.getElementById('rowsPerPage').value = rows;
document.getElementById('rowsPerPage').addEventListener('change', e=>{ rows=parseInt(e.target.value); page=1; render(); });
document.getElementById('search').addEventListener('input', ()=>{ page=1; render(); });
document.getElementById('prev').addEventListener('click', ()=>{ if(page>1) page--; render(); });
document.getElementById('next').addEventListener('click', ()=>{ page++; render(); });
document.getElementById('clearCart').addEventListener('click', ()=>{ cart=[]; saveCart(); renderCart(); });
document.getElementById('exportCart').addEventListener('click', exportOrder);
document.getElementById('checkoutBtn').addEventListener('click', async ()=>{
  if(cart.length===0) return alert("Cart empty!");

  // Prepare cart items
  const line_items = cart.map(it => ({
    price_data: {
      currency: 'usd',
      product_data: { name: it.name },
      unit_amount: it.price_cents
    },
    quantity: it.qty
  }));

  // Call your backend to create Stripe Checkout Session
  const res = await fetch('/create-checkout-session', {
    method: 'POST',
    headers: { 'Content-Type':'application/json' },
    body: JSON.stringify({ items: line_items })
  });

  const session = await res.json();
  const stripe = Stripe('YOUR_STRIPE_PUBLISHABLE_KEY');
  stripe.redirectToCheckout({ sessionId: session.id });
});


fetchProducts();

/* ============ Functions ============ */
async function fetchProducts(){
  try{ 
    const res = await fetch(PRODUCTS_FILE, {cache:'no-cache'});
    products = res.ok ? await res.json() : [];
  }catch(e){ products=[]; }
  filtered = products.slice();
  render();
  renderCart();
}

function searchFilter(){
  const q = document.getElementById('search').value.trim().toLowerCase();
  filtered = !q ? products.slice() : products.filter(p=>
    (p.name||'').toLowerCase().includes(q) ||
    (p.description||'').toLowerCase().includes(q) ||
    (p.sku||'').toLowerCase().includes(q)
  );
}

function render(){
  searchFilter();
  const perPage = rows * COLS;
  const start = (page-1) * perPage;
  const pageItems = filtered.slice(start, start + perPage);
  const maxPage = Math.max(1, Math.ceil(filtered.length / perPage));
  if(page > maxPage) page = maxPage;

  const grid = document.getElementById('grid');
  grid.innerHTML = '';
  for(const p of pageItems){
    const card = document.createElement('div'); card.className='card';
    card.innerHTML=`
      <img loading="lazy" src="${p.image_url || 'https://via.placeholder.com/400x260?text=No+Image'}" alt="${escapeHtml(p.name||'')}">
      <div class="meta">
        <div class="title">${escapeHtml(p.name||'Unnamed')}</div>
        <div class="desc">${escapeHtml(p.description||'')}</div>
        <div class="price">$${(p.price_cents/100).toFixed(2)}</div>
        <div class="stock" id="stock-${p.id}">${p.stock>0 ? 'In stock: ' + p.stock : '<span class="notavail">Not available</span>'}</div>
      </div>
      <div class="card-footer">
        <div style="flex:1"><button id="add-${p.id}" ${p.stock===0?'disabled':''}>Add to cart</button></div>
      </div>
    `;
    grid.appendChild(card);
    if(p.stock>0) document.getElementById(`add-${p.id}`).addEventListener('click', ()=> addToCart(p.id));
  }

  document.getElementById('pageInfo').textContent = `Page ${page} / ${maxPage} — showing ${Math.min(filtered.length-start, perPage)} of ${filtered.length}`;
  document.getElementById('prev').disabled = page <= 1;
  document.getElementById('next').disabled = page >= maxPage;
}

/* ============ Cart ============ */
function loadCart(){ try{ return JSON.parse(localStorage.getItem('lakspices_cart')||'[]'); }catch(e){ return []; } }
function saveCart(){ localStorage.setItem('lakspices_cart', JSON.stringify(cart)); }
function addToCart(id){
  const p=products.find(x=>x.id===id); if(!p) return; if(p.stock<=0) return;
  const it=cart.find(c=>c.id===id); if(it){ if(it.qty+1>p.stock) return; it.qty++; } else cart.push({id:id, name:p.name, price_cents:p.price_cents, qty:1});
  saveCart(); renderCart();
}
function incQty(id){ const it=cart.find(c=>c.id===id); if(!it) return; const p=products.find(x=>x.id===id); if(it.qty+1>p.stock) return; it.qty++; saveCart(); renderCart(); }
function decQty(id){ const it=cart.find(c=>c.id===id); if(!it) return; it.qty--; if(it.qty<=0) cart=cart.filter(x=>x.id!==id); saveCart(); renderCart(); }
function removeItem(id){ cart=cart.filter(x=>x.id!==id); saveCart(); renderCart(); }

function renderCart(){
  const elm=document.getElementById('cartList'); elm.innerHTML='';
  let totalCents=0, itemCount=0;
  for(const it of cart){
    const row=document.createElement('div'); row.className='cart-item';
    const p=products.find(x=>x.id===it.id) || {};
    totalCents+=(it.price_cents||p.price_cents||0)*it.qty;
    itemCount+=it.qty;
    row.innerHTML=`
      <div style="flex:1">
        <div style="font-weight:700">${escapeHtml(it.name)}</div>
        <div class="small">${it.qty} × $${((it.price_cents||p.price_cents)/100).toFixed(2)}</div>
      </div>
      <div style="display:flex;flex-direction:column; gap:6px; align-items:flex-end;">
        <div style="display:flex; gap:6px;">
          <button onclick="decQty(${it.id})">-</button>
          <button onclick="incQty(${it.id})">+</button>
        </div>
        <button onclick="removeItem(${it.id})">Remove</button>
      </div>
    `;
    elm.appendChild(row);
  }
  document.getElementById('total').textContent='Total: $'+(totalCents/100).toFixed(2);
  document.getElementById('itemCount').textContent=itemCount;
}

/* ============ Export Order ============ */
function exportOrder(){
  if(cart.length===0) return alert('Cart empty');
  const payload={date:new Date().toISOString(), items:cart, total_cents:cart.reduce((s,i)=>s+(i.price_cents*i.qty),0)};
  const blob=new Blob([JSON.stringify(payload,null,2)],{type:'application/json'});
  const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`lakspices-order-${Date.now()}.json`; a.click();
  URL.revokeObjectURL(url);
}

/* ============ PayPal Checkout ============ */
function renderPayPalButtons(){
  const container=document.getElementById('paypal-buttons'); container.innerHTML='';
  if(cart.length===0) return;
  const items=cart.map(it=>{
    const p=products.find(x=>x.id===it.id)||{};
    return { name:p.name||it.name, unit_amount:{currency_code:'USD', value:((it.price_cents||p.price_cents)/100).toFixed(2)}, quantity:String(it.qty) };
  });
  const total=items.reduce((s,i)=>s+(parseFloat(i.unit_amount.value)*parseInt(i.quantity)),0).toFixed(2);

  paypal.Buttons({
    style:{layout:'vertical', color:'gold', shape:'rect', label:'paypal'},
    createOrder:(data, actions)=> actions.order.create({ purchase_units:[{ amount:{ currency_code:'USD', value:total, breakdown:{item_total:{currency_code:'USD', value:total}} }, items }] }),
    onApprove:(data, actions)=> actions.order.capture().then(details=>{
      // Reduce stock locally
      for(const it of cart){ const p=products.find(x=>x.id===it.id); if(p) p.stock=Math.max(0,p.stock-it.qty); }
      localStorage.setItem('lakspices_products', JSON.stringify(products));
      cart=[]; saveCart(); render(); renderCart();
      alert('Payment successful: '+details.id);
    }),
    onError: err=>{ console.error(err); alert('PayPal error: '+err); }
  }).render('#paypal-buttons');
}

/* ============ Utils ============ */
function escapeHtml(s){ return (s+'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
</script>
</body>
</html>
